# crontab 使用

Linux crontab是用来定期执行程序的命令。

当安装完成操作系统之后，默认便会启动此任务调度命令。

crond 命令每分锺会定期检查是否有要执行的工作，如果有要执行的工作便会自动执行该工作。

注意：新创建的 cron 任务，不会马上执行，至少要过 2 分钟后才可以，当然你可以重启 cron 来马上执行。

而 linux 任务调度的工作主要分为以下两类：

1、系统执行的工作：系统周期性所要执行的工作，如备份系统数据、清理缓存
2、个人执行的工作：某个用户定期要做的工作，例如每隔10分钟检查邮件服务器是否有新信，这些工作可由每个用户自行设置

## 语法
crontab [ -u user ] file
或

crontab [ -u user ] { -l | -r | -e }

## 说明：

crontab 是用来让使用者在固定时间或固定间隔执行程序之用，换句话说，也就是类似使用者的时程表。

-u user 是指设定指定 user 的时程表，这个前提是你必须要有其权限(比如说是 root)才能够指定他人的时程表。如果不使用 -u user 的话，就是表示设定自己的时程表。

## 参数说明：

-e : 执行文字编辑器来设定时程表，内定的文字编辑器是 VI，如果你想用别的文字编辑器，则请先设定 VISUAL 环境变数来指定使用那个文字编辑器(比如说 setenv VISUAL joe)
-r : 删除目前的时程表
-l : 列出目前的时程表

## 时间格式如下：

f1 f2 f3 f4 f5 program
其中 f1 是表示分钟，f2 表示小时，f3 表示一个月份中的第几日，f4 表示月份，f5 表示一个星期中的第几天。program 表示要执行的程序。
当 f1 为 * 时表示每分钟都要执行 program，f2 为 * 时表示每小时都要执行程序，其馀类推
当 f1 为 a-b 时表示从第 a 分钟到第 b 分钟这段时间内要执行，f2 为 a-b 时表示从第 a 到第 b 小时都要执行，其馀类推
当 f1 为 */n 时表示每 n 分钟个时间间隔执行一次，f2 为 */n 表示每 n 小时个时间间隔执行一次，其馀类推
当 f1 为 a, b, c,... 时表示第 a, b, c,... 分钟要执行，f2 为 a, b, c,... 时表示第 a, b, c...个小时要执行，其馀类推
*    *    *    *    *
-    -    -    -    -
|    |    |    |    |
|    |    |    |    +----- 星期中星期几 (0 - 6) (星期天 为0)
|    |    |    +---------- 月份 (1 - 12)
|    |    +--------------- 一个月中的第几天 (1 - 31)
|    +-------------------- 小时 (0 - 23)
+------------------------- 分钟 (0 - 59)
使用者也可以将所有的设定先存放在文件中，用 crontab file 的方式来设定执行时间。

## crontab的范例格式：
下面是c r o n t a b的格式：
分< >时< >日< >月< >星期< >要运行的命令
其中< >表示空格。
C r o n t a b文件的一个条目是从左边读起的，第一列是分，最后一列是要运行的命令，它位
于星期的后面。
在这些域中，可以用横杠-来表示一个时间范围，例如你希望星期一至星期五运行某个作
业，那么可以在星期域使用1 - 5来表示。还可以在这些域中使用逗号“,”，例如你希望星期一
和星期四运行某个作业，只需要使用1 , 4来表示。可以用星号*来表示连续的时间段。如果你
对某个表示时间的域没有特别的限定，也应该在该域填入*。该文件的每一个条目必须含有5
个时间域，而且每个域之间要用空格分隔。该文件中所有的注释行要在行首用#来表示。

## crontab条目举例

这里有c r o n t a b文件条目的一些例子：
30 21* * * /apps/bin/cleanup.sh
上面的例子表示每晚的2 1 : 3 0运行/ a p p s / b i n目录下的c l e a n u p . s h。
45 4 1,10,22 * * /apps/bin/backup.sh
上面的例子表示每月1、1 0、2 2日的4 : 4 5运行/ a p p s / b i n目录下的b a c k u p . s h。
10 1 * * 6,0 /bin/find -name "core" -exec rm {} ;
上面的例子表示每周六、周日的1 : 1 0运行一个f i n d命令。
0,30 18-23 * * * /apps/bin/dbcheck.sh
上面的例子表示在每天1 8 : 0 0至2 3 : 0 0之间每隔3 0分钟运行/ a p p s / b i n目录下的d b c h e c k . s h。
0 23 * * 6 /apps/bin/qtrend.sh
上面的例子表示每星期六的11 : 0 0 p m运行/ a p p s / b i n目录下的q t r e n d . s h。



## 四、具体实例

sh脚本文件：test.sh

```bash
#! /bin/sh

su - oracle << EOF

sqlplus test/test@test @"test.sql"
```


sql脚本文件：test.sql
```sql92
insert into test_tb values (sysdate);
```


crontab文件：

0，15，30，45 * * * * /apps/bin/test.sh

service crond restart
crontab -e 43 16 * * * /home/mysql_backups/backup.sh

## 脚本无法执行问题
如果我们使用 crontab 来定时执行脚本，无法执行，但是如果直接通过命令（如：./test.sh)又可以正常执行，这主要是因为无法读取环境变量的原因。

解决方法：

1、所有命令需要写成绝对路径形式，如: /usr/local/bin/docker。
2、在 shell 脚本开头使用以下代码：
```shell
#!/bin/sh

. /etc/profile
. ~/.bash_profile
```

3、在 /etc/crontab 中添加环境变量，在可执行命令之前添加命令 . /etc/profile;/bin/sh，使得环境变量生效，例如：
```
20 03 * * * . /etc/profile;/bin/sh /var/www/runoob/test.sh
```

## 实例

每一分钟执行一次 /bin/ls：

* * * * * /bin/ls
          在 12 月内, 每天的早上 6 点到 12 点，每隔 3 个小时 0 分钟执行一次 /usr/bin/backup：

0 6-12/3 * 12 * /usr/bin/backup
周一到周五每天下午 5:00 寄一封信给 alex@domain.name：

0 17 * * 1-5 mail -s "hi" alex@domain.name < /tmp/maildata
每月每天的午夜 0 点 20 分, 2 点 20 分, 4 点 20 分....执行 echo "haha"：

20 0-23/2 * * * echo "haha"
下面再看看几个具体的例子：

0 */2 * * * /sbin/service httpd restart  意思是每两个小时重启一次apache

50 7 * * * /sbin/service sshd start  意思是每天7：50开启ssh服务

50 22 * * * /sbin/service sshd stop  意思是每天22：50关闭ssh服务

0 0 1,15 * * fsck /home  每月1号和15号检查/home 磁盘

1 * * * * /home/bruce/backup  每小时的第一分执行 /home/bruce/backup这个文件

00 03 * * 1-5 find /home "*.xxx" -mtime +4 -exec rm {} \;  每周一至周五3点钟，在目录/home中，查找文件名为*.xxx的文件，并删除4天前的文件。

30 6 */10 * * ls  意思是每月的1、11、21、31日是的6：30执行一次ls命令
注意：当程序在你所指定的时间执行后，系统会发一封邮件给当前的用户，显示该程序执行的内容，若是你不希望收到这样的邮件，请在每一行空一格之后加上 > /dev/null 2>&1 即可，如：

20 03 * * * . /etc/profile;/bin/sh /var/www/runoob/test.sh > /dev/null 2>&1 

## CRON表达式：

0 */12 * * *


CRON表达式是一个字符串，包含五个到七个由空格分隔的字段（每种软件不一样），表示一组时间，通常作为执行某个程序的时间表。

注释以注释标记#开始，并且必须单独在一行上。

Linux: 0 */12 * * * [user] [command] 请只输入红色部分。

Java(Spring): 0 0 */12 * * * 请只输入红色部分。

Java(Quartz): 0 0 18 L * ? 请只输入红色部分。

接下来7次的执行时间：
请点击"查看执行时间"按钮。
例子：
### 每月的最后1天
0 0 L * * *

    说明：
    Linux
    *    *    *    *    *
    -    -    -    -    -
    |    |    |    |    |
    |    |    |    |    +----- day of week (0 - 7) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
    |    |    |    +---------- month (1 - 12) OR jan,feb,mar,apr ...
    |    |    +--------------- day of month (1 - 31)
    |    +-------------------- hour (0 - 23)
    +------------------------- minute (0 - 59)

字段	是否必填	允许值	允许特殊字符	备注
Seconds	是	0–59	*,-	标准实现不支持此字段。
Minutes	是	0–59	*,-
Hours	是	0–23	*,-
Day of month	是	1–31	*,-?LW	?LW只有部分软件实现了
Month	是	1–12 or JAN–DEC	*,-
Day of week	是	0–7 or SUN–SAT	*,-?L#	?L#只有部分软件实现了
Linux和Spring的允许值为0-7，0和7为周日
Quartz的允许值为1-7，1为周日
Year	否	1970–2099	*,-	标准实现不支持此字段。
标准字段
逗号用于分隔列表。例如，在第5个字段(星期几)中使用 MON,WED,FRI 表示周一、周三和周五。

连字符定义范围。例如，2000-2010 表示2000年至2010年期间的每年，包括2000年和2010年。

除非用反斜杠(\)转义，否则命令中的百分号(%)会被替换成换行符，第一个百分号后面的所有数据都会作为标准输入发送给命令。

非标准字段
“L”代表“Last”。当在星期几字段中使用的时候，可以指定给定月份的结构，例如“最后一个星期五”(5L)。在月日字段中，可以指定一个月的最后一天。

“day of month”字段可以使用“W”字符。指定最接近给定日期的工作日（星期一-星期五）。例如，15W，意思是：“最接近该月15日的工作日。”；所以，如果15号是星期六，触发器在14号星期五触发。如果15日是星期天，触发器在16日星期一触发。如果15号是星期二，那么它在15号星期二触发。“1W”，如果这个月的第一天是星期六，不会跨到上个月，触发器会在这个月的第三天（也就是星期一）触发。只有指定一天（不能是范围或列表）的时候，才能指定“W”字符。

星期几字段可以使用“#”，后面必须跟一个介于1和5之间的数字。例如，5#3表示每个月的第三个星期五。

在某些实现中，“?”用来代替“*”以将月中的某一天或周中的某一天留空。其他cron的实现是替换“?”为cron守护进程的启动时间，例如：？？* * * *，如果cron在上午8:25启动，将更新为25 8 * * * *并在每天的这个时间运行，直到再次重新启动。

分钟字段设置 */5表示每5分钟一次，注意：这里指的是能被5整除的分钟数。
